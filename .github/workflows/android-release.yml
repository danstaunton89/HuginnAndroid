name: Android Release Build

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get next version from Play Store
        env:
          GOOGLE_PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
        run: |
          pip install --quiet google-auth google-auth-httplib2 google-api-python-client

          echo "$GOOGLE_PLAY_SERVICE_ACCOUNT_JSON" > service-account.json

          VERSION=$(python3 << 'END'
          from google.oauth2 import service_account
          from googleapiclient.discovery import build

          SCOPES = ['https://www.googleapis.com/auth/androidpublisher']
          PACKAGE_NAME = 'com.blacksquirrel.healthtracker'

          credentials = service_account.Credentials.from_service_account_file(
              'service-account.json', scopes=SCOPES)
          service = build('androidpublisher', 'v3', credentials=credentials)

          # Get all version codes from internal track
          edit = service.edits().insert(packageName=PACKAGE_NAME, body={}).execute()
          edit_id = edit['id']

          tracks = service.edits().tracks().get(
              packageName=PACKAGE_NAME,
              editId=edit_id,
              track='internal'
          ).execute()

          # Find the highest version code
          max_version = 90  # Start from 90 (our last successful release)
          if 'releases' in tracks:
              for release in tracks['releases']:
                  if 'versionCodes' in release:
                      for vc in release['versionCodes']:
                          if int(vc) > max_version:
                              max_version = int(vc)

          # Increment by 1
          next_version = max_version + 1
          print(next_version)
          END
          )

          rm -f service-account.json

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Next version will be: $VERSION"

          # Update build.gradle with this version
          sed -i "s/versionCode [0-9]*/versionCode $VERSION/" android/app/build.gradle
          sed -i "s/versionName \"[^\"]*\"/versionName \"$VERSION\"/" android/app/build.gradle

          # Verify
          echo "Updated build.gradle:"
          grep -E "versionCode|versionName" android/app/build.gradle

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create keystore file
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" > keystore.b64
          base64 -di keystore.b64 > android/app/release.keystore
          rm keystore.b64
          ls -lh android/app/release.keystore

      - name: Create keystore.properties
        run: |
          echo "MYAPP_UPLOAD_STORE_FILE=release.keystore" > android/keystore.properties
          echo "MYAPP_UPLOAD_STORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> android/keystore.properties
          echo "MYAPP_UPLOAD_KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> android/keystore.properties
          echo "MYAPP_UPLOAD_KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> android/keystore.properties

      - name: Make gradlew executable
        working-directory: android
        run: chmod +x gradlew

      - name: Build Android App Bundle
        working-directory: android
        run: ./gradlew bundleRelease --no-daemon

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-bundle
          path: android/app/build/outputs/bundle/release/app-release.aab
          retention-days: 30

      - name: Upload to Google Play Store
        env:
          GOOGLE_PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
        run: |
          echo "Uploading version $VERSION to Google Play..."

          pip install --quiet google-auth google-auth-httplib2 google-api-python-client

          echo "$GOOGLE_PLAY_SERVICE_ACCOUNT_JSON" > service-account.json

          python3 << END
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload

          SCOPES = ['https://www.googleapis.com/auth/androidpublisher']
          PACKAGE_NAME = 'com.blacksquirrel.healthtracker'
          VERSION = $VERSION
          AAB_FILE = 'android/app/build/outputs/bundle/release/app-release.aab'

          credentials = service_account.Credentials.from_service_account_file(
              'service-account.json', scopes=SCOPES)

          service = build('androidpublisher', 'v3', credentials=credentials)

          # Create edit
          edit = service.edits().insert(packageName=PACKAGE_NAME, body={}).execute()
          edit_id = edit['id']
          print(f"Created edit: {edit_id}")

          # Upload AAB
          print(f"Uploading {AAB_FILE}...")
          bundle_response = service.edits().bundles().upload(
              packageName=PACKAGE_NAME,
              editId=edit_id,
              media_body=MediaFileUpload(AAB_FILE, mimetype='application/octet-stream')
          ).execute()
          print(f"Uploaded bundle with versionCode: {bundle_response['versionCode']}")

          # Create release on closed testing track (alpha)
          # Closed testing allows specific testers only and may enable auto-publish
          track_response = service.edits().tracks().update(
              packageName=PACKAGE_NAME,
              editId=edit_id,
              track='alpha',
              body={
                  'releases': [{
                      'name': str(VERSION),
                      'versionCodes': [str(VERSION)],
                      'status': 'completed',
                      'releaseNotes': [{'language': 'en-US', 'text': f'Version {VERSION}'}]
                  }]
              }
          ).execute()
          print(f"Release {VERSION} published to closed testing!")

          # Commit
          commit = service.edits().commit(packageName=PACKAGE_NAME, editId=edit_id).execute()
          print(f"Successfully published version {VERSION}!")
          END

          rm -f service-account.json
          echo "Done!"
